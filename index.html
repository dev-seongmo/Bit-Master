<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hex-Bit Master Online</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        /* --- Ïä§ÌÉÄÏùº (ÎîîÏûêÏù∏) --- */
        :root { --bg-color: #0d0d0d; --card-bg: #1a1a1a; --terminal-green: #39ff14; --terminal-amber: #ffb000; --terminal-cyan: #00eaff; --terminal-red: #ff3333; --inactive-bit: #333; --text: #e0e0e0; }
        html, body { height: 100%; overflow: hidden; overscroll-behavior: none; }
        body { font-family: 'VT323', monospace; background-color: var(--bg-color); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0; background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; -webkit-user-select: none; user-select: none; touch-action: none; }
        
        #game-container { 
            text-align: center; background: var(--card-bg); padding: 1.5rem; border: 4px solid var(--inactive-bit); 
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8); 
            width: 400px; max-width: 95vw; /* Ìè≠ÏùÑ Ï°∞Í∏à Îçî Ïú†Ïó∞ÌïòÍ≤å */
            touch-action: manipulation; transition: border-color 0.1s; display: flex; flex-direction: column; align-items: center; 
            max-height: 98vh; /* ÎÜíÏù¥ Ï†úÌïúÏùÑ Ï°∞Í∏à Îçî ÌíÇ */
            overflow-y: auto; position: relative; 
        }
        #game-container::-webkit-scrollbar { width: 8px; } #game-container::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; } #game-container::-webkit-scrollbar-track { background: transparent; }
        
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); border-color: var(--terminal-red); color: var(--terminal-red); } 30% { transform: translate(3px, 2px) rotate(0deg); border-color: var(--terminal-red); } 50% { transform: translate(-1px, 2px) rotate(-1deg); border-color: var(--terminal-red); } 70% { transform: translate(3px, 1px) rotate(-1deg); border-color: var(--terminal-red); } 100% { transform: translate(1px, -2px) rotate(0deg); } }
        .error-shake { animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both; }
        
        h1 { color: var(--terminal-green); text-shadow: 0 0 10px var(--terminal-green); font-size: 2.2rem; margin: 0 0 10px 0; letter-spacing: 2px; line-height: 1; }
        
        #level-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }
        .level-btn { background: transparent; border: 2px solid var(--terminal-green); color: var(--terminal-green); font-family: 'VT323', monospace; padding: 8px; cursor: pointer; text-align: left; transition: all 0.2s; position: relative; box-shadow: 0 0 5px var(--terminal-green); }
        .level-btn:active { transform: scale(0.96); } .level-title { font-size: 1.3rem; font-weight: bold; display: block; } .level-desc { font-size: 0.8rem; color: #888; display: block; margin-top: 3px; }
        .level-btn.full-width { grid-column: span 2; text-align: center; border-color: var(--terminal-cyan); color: var(--terminal-cyan); box-shadow: 0 0 5px var(--terminal-cyan); }
        .level-btn.hard-mode { grid-column: span 2; text-align: center; border-color: var(--terminal-amber); color: var(--terminal-amber); box-shadow: 0 0 5px var(--terminal-amber); margin-top: 5px; }
        .level-btn.ranking-mode { grid-column: span 2; text-align: center; border-color: #eee; color: #eee; box-shadow: 0 0 5px #eee; margin-top: 15px; }
        .locked { opacity: 0.5; border-style: dashed; cursor: not-allowed; }
        
        #hex-display { font-size: 5rem; font-weight: bold; margin: 5px 0; color: var(--terminal-amber); text-shadow: 0 0 15px var(--terminal-amber); letter-spacing: 5px; }
        .stats { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; font-size: 1.5rem; color: var(--terminal-green); }
        
        /* --- ÎπÑÌä∏ Î≤ÑÌäº Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº --- */
        .bit-container-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; justify-items: center; width: 100%; }
        
        /* [ÏàòÏ†ïÎê®] ÌïòÎìúÎ™®Îìú Ï†ÑÏö© Î†àÏù¥ÏïÑÏõÉ: Î≤ÑÌäº ÌÅ¨Í∏∞Î•º Ï§ÑÏù¥Í≥† Í∞ÑÍ≤©ÏùÑ Ï¢ÅÌûò */
        .bit-container-grid.hard-mode-layout { 
            grid-template-columns: repeat(4, 1fr) 0.2fr repeat(4, 1fr); /* 4Í∞ú-Í≥µÎ∞±-4Í∞ú */
            grid-template-rows: auto; 
            width: 100%; 
            gap: 4px; /* Í∞ÑÍ≤©ÏùÑ 10px -> 4pxÎ°ú Ï§ÑÏûÑ */
        }

        .bit-wrapper { display: flex; flex-direction: column; align-items: center; }
        
        /* Í∏∞Î≥∏ Î≤ÑÌäº ÌÅ¨Í∏∞ */
        .bit-btn { width: 50px; height: 50px; border: 3px solid var(--inactive-bit); background: #000; cursor: pointer; transition: background-color 0.05s; box-shadow: inset 0 0 10px #000; }
        
        /* [Ï∂îÍ∞ÄÎê®] ÌïòÎìúÎ™®ÎìúÏùº Îïå Î≤ÑÌäº ÌÅ¨Í∏∞Î•º Í∞ïÏ†úÎ°ú Ï§ÑÏûÑ */
        .hard-mode-layout .bit-btn {
            width: 38px;
            height: 38px;
            border-width: 2px; /* ÌÖåÎëêÎ¶¨ÎèÑ ÏÇ¥Ïßù ÏñáÍ≤å */
        }

        .bit-btn.active { background: var(--terminal-green) !important; border-color: var(--terminal-green); box-shadow: 0 0 20px var(--terminal-green); }
        .bit-label { margin-top: 3px; font-size: 0.8rem; color: #888; }
        
        .submit-btn { width: 100%; padding: 10px; font-size: 1.5rem; font-family: 'VT323', monospace; background: transparent; color: var(--terminal-green); border: 2px solid var(--terminal-green); cursor: pointer; text-shadow: 0 0 5px var(--terminal-green); box-shadow: 0 0 5px var(--terminal-green); margin-top: 10px; } 
        .submit-btn:active { transform: scale(0.98); }
        
        .rank-input-area { margin: 20px 0; border-top: 1px dashed #333; padding-top: 15px; width: 100%; } .rank-input { background: #000; border: 1px solid var(--terminal-green); color: var(--terminal-green); font-family: 'VT323', monospace; font-size: 1.5rem; width: 60%; padding: 5px; text-align: center; outline: none; }
        .rank-list { width: 100%; margin-top: 5px; text-align: left; font-size: 1rem; max-height: 250px; overflow-y: auto; } .rank-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
        .rank-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; width: 100%; }
        .nav-btn { background: none; border: 1px solid var(--terminal-cyan); color: var(--terminal-cyan); cursor: pointer; font-family: 'VT323'; font-size: 1.2rem; padding: 0 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>HEX-BIT ONLINE</h1>

        <div id="start-screen" style="width: 100%;">
            <p style="font-size: 1rem; margin-bottom: 10px; color:#888;">SELECT TRAINING LEVEL</p>
            <div id="level-menu">
                <button class="level-btn" onclick="window.startGame('1-1')"><span class="level-title">LV 1-1. BASIC</span><span class="level-desc">0, 1, 2, 4, 8, F</span></button>
                <button class="level-btn" onclick="window.startGame('1-2')"><span class="level-title">LV 1-2. INVERT</span><span class="level-desc">7, B, D, E</span></button>
                <button class="level-btn" onclick="window.startGame('1-3')"><span class="level-title">LV 1-3. MIXED</span><span class="level-desc">3, 5, 6, 9, A, C</span></button>
                <button class="level-btn full-width" onclick="window.startGame('1-4')"><span class="level-title">LV 1-4. MASTER</span><span class="level-desc">All Single Hex</span></button>
                <button id="btn-hard" class="level-btn hard-mode locked" onclick="window.startGame('hard')"><span class="level-title">‚ö† HARD MODE ‚ö†</span><span class="level-desc">LOCKED (Need LV1-4 Master)</span></button>
                <button class="level-btn ranking-mode" onclick="window.openRankingMode()">
                    <span class="level-title">üèÜ HALL OF FAME</span><span class="level-desc">Check Global Rankings</span>
                </button>
            </div>
        </div>

        <div id="game-play" class="hidden" style="width: 100%;">
            <div style="color:#666; font-size: 1.2rem;" id="level-tag">LEVEL</div>
            <div class="stats"><div>TIME: <span id="timer">30</span>s</div><div>SCORE: <span id="score">0</span></div></div>
            <div id="hex-display">0x00</div>
            <div id="bit-container-dynamic" class="bit-container-grid"></div>
            <button class="submit-btn" onclick="window.checkAnswer()">SUBMIT DATA</button>
        </div>

        <div id="result-screen" class="hidden" style="width: 100%;">
            <h2 style="color:var(--terminal-green)">TRAINING FINISHED</h2>
            <p style="font-size: 1.5rem;">FINAL SCORE: <span id="final-score" style="color:var(--terminal-amber)">0</span></p>
            <div id="rank-display"></div>
            <div id="unlock-msg-area"></div>
            <div id="ranking-form" class="rank-input-area hidden">
                <p style="margin:0 0 10px 0; color:#888;">ENTER AGENT NAME</p>
                <input type="text" id="player-name" class="rank-input" maxlength="8" placeholder="AAA">
                <button class="submit-btn" onclick="window.submitScore()" style="width: 30%; font-size: 1.2rem; display: inline-block;">SAVE</button>
            </div>
            <button class="submit-btn" onclick="location.reload()" style="margin-top:20px;">RETURN TO MENU</button>
        </div>

        <div id="ranking-view" class="hidden" style="width: 100%;">
            <h2 style="color:var(--terminal-cyan); margin-bottom:20px;">GLOBAL RANKING</h2>
            <div class="rank-nav">
                <button class="nav-btn" onclick="window.changeRankLevel(-1)">‚óÄ PREV</button>
                <span id="rank-view-title" style="font-size:1.3rem; color:var(--terminal-amber); font-weight:bold;">HARD MODE</span>
                <button class="nav-btn" onclick="window.changeRankLevel(1)">NEXT ‚ñ∂</button>
            </div>
            <div id="rank-list-container-view" class="rank-list">Loading...</div>
            <button class="submit-btn" onclick="location.reload()" style="margin-top:20px;">BACK TO MENU</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
    apiKey: "AIzaSyAHeys0Ok10AJPqnS50po809kX76C4jMLk",
    authDomain: "bit-master-285db.firebaseapp.com",
    projectId: "bit-master-285db",
    storageBucket: "bit-master-285db.firebasestorage.app",
    messagingSenderId: "620682124332",
    appId: "1:620682124332:web:acd38f2860625b6a578589",
    measurementId: "G-55872VH1PD"
  };


        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected");
        } catch (e) { console.warn("Firebase Config Error"); }

        // --- Ï†ÑÏó≠ Î≥ÄÏàò ---
        const LEVELS = { '1-1': [0x0, 0x1, 0x2, 0x4, 0x8, 0xF], '1-2': [0x7, 0xB, 0xD, 0xE], '1-3': [0x3, 0x5, 0x6, 0x9, 0xA, 0xC], '1-4': Array.from({ length: 16 }, (_, i) => i) };
        const RANK_ORDER = ['hard', '1-4', '1-3', '1-2', '1-1'];
        let currentRankIndex = 0; 

        let score = 0, timeLeft = 30, currentTarget = -1, currentBits = [], gameActive = false, timerInterval, currentLevel = '1-1';
        let isHardUnlocked = localStorage.getItem('hexMasterHardUnlockedV2') === 'true';

        window.onload = function () { updateHardModeButton(); document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false }); };

        // --- Í≤åÏûÑ ÏãúÏûë (ÌïòÎìúÎ™®Îìú Ïû†Í∏à Ï≤¥ÌÅ¨ Ìè¨Ìï®) ---
        window.startGame = function (level) {
            if (level === 'hard' && !isHardUnlocked) {
                alert("üîí Access Denied: SCORE 22+ in LEVEL 1-4 ");
                return;
            }
            currentLevel = level;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-play').classList.remove('hidden');
            document.getElementById('level-tag').innerText = level === 'hard' ? 'HARD MODE' : `LEVEL ${level}`;
            const bitCount = (level === 'hard') ? 8 : 4;
            setupBitButtons(bitCount);
            score = 0; timeLeft = 30; gameActive = true; document.getElementById('score').innerText = score; currentTarget = -1; nextQuestion();
            timerInterval = setInterval(() => { timeLeft--; document.getElementById('timer').innerText = timeLeft; if (timeLeft <= 0) endGame(); }, 1000);
        };

        window.openRankingMode = function() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('ranking-view').classList.remove('hidden');
            currentRankIndex = 0; updateRankView();
        }

        window.changeRankLevel = function(direction) {
            currentRankIndex += direction;
            if (currentRankIndex < 0) currentRankIndex = RANK_ORDER.length - 1;
            if (currentRankIndex >= RANK_ORDER.length) currentRankIndex = 0;
            updateRankView();
        }

        function updateRankView() {
            const levelCode = RANK_ORDER[currentRankIndex];
            const title = levelCode === 'hard' ? 'HARD MODE' : `LEVEL ${levelCode}`;
            document.getElementById('rank-view-title').innerText = title;
            fetchLeaderboard(levelCode, 'rank-list-container-view');
        }

        window.checkAnswer = function () {
            if (!gameActive) return;
            let val = 0;
            for(let i=0; i<currentBits.length; i++) { if(currentBits[i] === 1) val += Math.pow(2, i); }
            if (val === currentTarget) { score++; document.getElementById('score').innerText = score; nextQuestion(); } 
            else { const container = document.getElementById('game-container'); container.classList.remove('error-shake'); void container.offsetWidth; container.classList.add('error-shake'); setTimeout(() => resetBits(), 500); }
        };

        function setupBitButtons(count) {
            const container = document.getElementById('bit-container-dynamic'); container.innerHTML = ''; currentBits = new Array(count).fill(0); container.className = 'bit-container-grid';
            if (count === 8) { container.classList.add('hard-mode-layout'); for (let i = 7; i >= 4; i--) createBitBtn(i, container); container.appendChild(document.createElement('div')); for (let i = 3; i >= 0; i--) createBitBtn(i, container); } 
            else { 
                container.classList.remove('hard-mode-layout'); // ÏùºÎ∞ò Î™®ÎìúÏùº Îïê ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
                for (let i = count - 1; i >= 0; i--) createBitBtn(i, container); 
            }
        }

        function createBitBtn(i, container) {
            const wrapper = document.createElement('div'); wrapper.className = 'bit-wrapper'; const btn = document.createElement('div'); btn.className = 'bit-btn'; btn.id = `bit-${i}`;
            const handle = (e) => { if (!gameActive) return; if (e.type === 'touchstart') e.preventDefault(); toggleBit(i); };
            btn.addEventListener('touchstart', handle, { passive: false }); btn.addEventListener('mousedown', handle);
            const label = document.createElement('div'); label.className = 'bit-label'; label.innerText = i; wrapper.appendChild(btn); wrapper.appendChild(label); container.appendChild(wrapper);
        }

        function toggleBit(index) { currentBits[index] = currentBits[index] === 0 ? 1 : 0; document.getElementById(`bit-${index}`).classList.toggle('active'); }
        function resetBits() { currentBits.fill(0); document.querySelectorAll('.bit-btn').forEach(el => el.classList.remove('active')); }
        function nextQuestion() {
            let newTarget, pool = [];
            if (currentLevel === 'hard') { do { newTarget = Math.floor(Math.random() * (240)) + 16; } while (newTarget === currentTarget); } 
            else { pool = LEVELS[currentLevel]; do { newTarget = pool[Math.floor(Math.random() * pool.length)]; } while (newTarget === currentTarget && pool.length > 1); }
            currentTarget = newTarget;
            let hexString = currentTarget.toString(16).toUpperCase(); if (hexString.length === 1 && currentLevel === 'hard') hexString = '0' + hexString;
            document.getElementById('hex-display').innerText = '0x' + hexString; resetBits();
        }

        function updateHardModeButton() { const btn = document.getElementById('btn-hard'); if (isHardUnlocked) { btn.classList.remove('locked'); btn.querySelector('.level-desc').innerText = "0x10 ~ 0xFF (8-BIT)"; } }

        function endGame() {
            gameActive = false; clearInterval(timerInterval); document.getElementById('game-container').classList.remove('error-shake');
            document.getElementById('game-play').classList.add('hidden'); document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score; document.getElementById('ranking-form').classList.remove('hidden'); 
            const unlockMsg = document.getElementById('unlock-msg-area'); unlockMsg.innerHTML = '';
            const rank = getRank(score); const rankDiv = document.getElementById('rank-display'); rankDiv.innerText = rank.name; rankDiv.style.color = rank.color;
            if (score >= 22) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); if (currentLevel === '1-4' && !isHardUnlocked) { isHardUnlocked = true; localStorage.setItem('hexMasterHardUnlockedV2', 'true'); const msg = document.createElement('p'); msg.className = 'unlock-message'; msg.innerText = ">>> SYSTEM ALERT: HARD MODE UNLOCKED <<<"; msg.style.color = "var(--terminal-red)"; msg.style.fontWeight = "bold"; unlockMsg.appendChild(msg); } }
        }
        function getRank(s) { if (s >= 22) return { name: "MASTER üëë", color: "#ff00ff" }; if (s >= 18) return { name: "DIAMOND üíé", color: "#00eaff" }; if (s >= 14) return { name: "PLATINUM üíç", color: "#e0e0e0" }; if (s >= 10) return { name: "GOLD ü•á", color: "#ffd700" }; if (s >= 5) return { name: "SILVER ü•à", color: "#c0c0c0" }; return { name: "BRONZE ü•â", color: "#cd7f32" }; }

        window.submitScore = async function () {
            const nameInput = document.getElementById('player-name'); const name = nameInput.value.trim().toUpperCase();
            if (!name) return alert("AGENT NAME REQUIRED!"); if (!db) return alert("DB CONNECT ERROR"); nameInput.disabled = true;
            try {
                const q = query(collection(db, "leaderboard"), where("name", "==", name), where("level", "==", currentLevel));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    await addDoc(collection(db, "leaderboard"), { name: name, score: score, level: currentLevel, timestamp: serverTimestamp() });
                    alert("NEW RECORD SAVED!");
                } else {
                    const oldDoc = snapshot.docs[0]; const oldData = oldDoc.data();
                    if (score > oldData.score) {
                        await updateDoc(doc(db, "leaderboard", oldDoc.id), { score: score, timestamp: serverTimestamp() });
                        alert(`SCORE UPDATED! (${oldData.score} -> ${score})`);
                    } else { alert(`KEEP TRYING! (Current High: ${oldData.score})`); }
                }
                location.reload();
            } catch (e) { console.error(e); alert("ERROR: " + e.message); nameInput.disabled = false; }
        };

        async function fetchLeaderboard(targetLevel, containerId) {
            if (!db) return;
            const listContainer = document.getElementById(containerId);
            listContainer.innerHTML = "Fetching Data...";
            try { 
                const q = query(collection(db, "leaderboard"), where("level", "==", targetLevel), orderBy("score", "desc"), limit(20)); 
                const querySnapshot = await getDocs(q); 
                let html = ""; let rank = 1; 
                querySnapshot.forEach((doc) => { 
                    const data = doc.data(); 
                    let medal = rank === 1 ? "ü•á" : rank === 2 ? "ü•à" : rank === 3 ? "ü•â" : `<span style='color:#666'>${rank}.</span>`; 
                    html += `<div class="rank-item"><span>${medal} ${data.name}</span><span>${data.score} pts</span></div>`; 
                    rank++; 
                }); 
                if (html === "") html = "<p style='color:#666; text-align:center;'>NO DATA YET</p>"; 
                listContainer.innerHTML = html; 
            } catch (e) { console.error(e); listContainer.innerHTML = "Error loading ranks"; }
        }
    </script>
</body>
</html>